<?php
/**
 * THIS IS AN AUTOGENERATED FILE
 * DO NOT MODIFY
 * @codingStandardsIgnoreFile
 */

namespace Ls\Omni\Client\Ecommerce\Operation;

use Magento\Framework\App\ObjectManager;

class GetStores_GetStores
{
    public string $baseUrl;
    public array $connectionParams;
    public string $companyName;
    public \Ls\Omni\Client\Ecommerce\Entity\GetStores_GetStoresRequest $request;
    public \Ls\Omni\Client\Ecommerce\Entity\GetStores_GetStoresResponse $response;
    public \Ls\Omni\Helper\Data $dataHelper;

    public function __construct(string $baseUrl = '', array $connectionParams = [], string $companyName = '')
    {
        $this->baseUrl = $baseUrl;
        $this->connectionParams = $connectionParams;
        $this->companyName = $companyName;
        $this->dataHelper = $this->createInstance(\Ls\Omni\Helper\Data::class);
        $this->request = $this->createInstance(\Ls\Omni\Client\Ecommerce\Entity\GetStores_GetStoresRequest::class);
    }

    public function execute(): \Ls\Omni\Client\Ecommerce\Entity\GetStores_GetStoresResponse
    {
        $raw = $this->dataHelper->makeRequest(
            \Ls\Omni\Client\Ecommerce\Entity\GetStores_GetStoresRequest::ACTION_NAME,
            self::class,
            $this->request,
            $this->baseUrl,
            $this->connectionParams,
            ['company' => $this->companyName]
        );

        $response = $this->formatResponse($raw);
        $this->setResponse($response);

        return $response;
    }

    public function formatResponse($data): \Ls\Omni\Client\Ecommerce\Entity\GetStores_GetStoresResponse
    {
        $requiredDataSetName = explode(',', 'LSCStore,LSCStoreGroupSetup,LSCStorePriceGroup,LSCSalesType');
        $finalEntry = $this->createInstance(\Ls\Omni\Client\Ecommerce\Entity\GetStores_GetStores::class);
        if (is_array($requiredDataSetName)) {
            foreach ($requiredDataSetName as $dataSet) {
                $entityClassName = str_replace(' ', '', $dataSet);
                // Try flat response structure
                if (isset($data[$dataSet]) && is_array($data[$dataSet])) {
                    $entity = $this->createInstance(
                        \Ls\Omni\Client\Ecommerce\Entity\GetStores_GetStores::class,
                         ['data' => $data['LSCStore,LSCStoreGroupSetup,LSCStorePriceGroup,LSCSalesType']]
                     );

                    return $this->createInstance(
                        \Ls\Omni\Client\Ecommerce\Entity\GetStores_GetStoresResponse::class,
                       [
                       'data' =>
                           [
                                'records' => [$entity],
                                'ResponseCode' => $data['ResponseCode'] ?? '',
                                'ErrorText' => $data['ErrorText'] ?? '',
                           ]
                       ]
                    );
                }
                $fields = $rows = [];
                $recRef = $this->findNestedDataSet($data, $entityClassName);
                if ($recRef && isset($recRef['DataSetFields'], $recRef['DataSetRows'])) {
                    if (isset($recRef['DataSetFields'])) {
                        foreach ($recRef['DataSetFields'] as $field) {
                            $fields[$field['FieldIndex']] = $field['FieldName'];
                        }
                    }

                    if (isset($recRef['DataSetRows'])) {
                        $rows = $recRef['DataSetRows'];
                    }
                    $className = '\Ls\Omni\Client\Ecommerce\Entity'.'\\'.$entityClassName;
                    $count = count($rows);
                    $entries = [];
                    foreach ($rows as $index => $row) {
                        $entry = $this->createInstance($className);
                        foreach ($row['Fields'] ?? [] as $field) {
                            $entry->setData($fields[$field['FieldIndex']], $field['FieldValue']);
                        }
                        $entries[$index] = $entry;
                    }
                    if (!empty($entries)) {
                        $finalEntry->setData($entityClassName, $count > 1 ? $entries : current($entries));
                    }
                }
            }
            return $this->createInstance(
                \Ls\Omni\Client\Ecommerce\Entity\GetStores_GetStoresResponse::class,
                [
                'data' =>
                    [
                        'records' => [$finalEntry],
                        'ResponseCode' => $data['ResponseCode'] ?? '',
                        'ErrorText' => $data['ErrorText'] ?? '',
                    ]
                ]
            );
        }
        return $this->createInstance(
            \Ls\Omni\Client\Ecommerce\Entity\GetStores_GetStoresResponse::class,
             [
             'data' =>
                 [
                    'records' => [],
                    'ResponseCode' => $data['ResponseCode'] ?? '',
                    'ErrorText' => $data['ErrorText'] ?? 'Unable to parse response.',
                 ]
            ]
        );
    }

    public function findNestedDataSet($data, string $target): ?array
    {
        if (is_array($data)) {
            foreach ($data as $key => $value) {
                if (is_array($value) || is_object($value)) {
                    $found = $this->findNestedDataSet((array)$value, $target);
                    if (!empty($found)) {
                        return $found;
                    }
                }

                if (
                    is_array($data)
                    && isset($data['DataSetName'])
                    && str_replace(' ', '',$data['DataSetName']) === $target
                ) {
                    return $data;
                }
            }
        }

        return null;
    }

    public function createInstance(string $entityClassName, array $data = [])
    {
        return ObjectManager::getInstance()->create($entityClassName, $data);
    }

    public function & setOperationInput(array $params = []): \Ls\Omni\Client\Ecommerce\Entity\GetStores_GetStoresRequest
    {
        $this->setRequest(
            $this->createInstance(
                \Ls\Omni\Client\Ecommerce\Entity\GetStores_GetStoresRequest::class,
                ['data' => $params]
            )
        );
        $request = $this->getRequest();

        return $request;
    }

    public function setRequest(\Ls\Omni\Client\Ecommerce\Entity\GetStores_GetStoresRequest $request): self
    {
        $this->request = $request;
        return $this;
    }

    public function setResponse(\Ls\Omni\Client\Ecommerce\Entity\GetStores_GetStoresResponse $response): self
    {
        $this->response = $response;
        return $this;
    }

    public function getRequest(): \Ls\Omni\Client\Ecommerce\Entity\GetStores_GetStoresRequest
    {
        return $this->request;
    }

    public function getResponse(): \Ls\Omni\Client\Ecommerce\Entity\GetStores_GetStoresResponse
    {
        return $this->response;
    }
}