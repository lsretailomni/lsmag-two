<?php
/**
 * THIS IS AN AUTOGENERATED FILE
 * DO NOT MODIFY
 * @codingStandardsIgnoreFile
 */

namespace Ls\Omni\Client\Ecommerce\Operation;

use Magento\Framework\App\ObjectManager;

class TestConnectionResponse
{
    public string $baseUrl;
    public array $connectionParams;
    public string $companyName;
    public \Ls\Omni\Client\Ecommerce\Entity\TestConnectionOData_TestConnection $request;
    public \Ls\Omni\Client\Ecommerce\Entity\TestConnectionResponseResponse $response;
    public \Ls\Omni\Helper\Data $dataHelper;

    public function __construct(string $baseUrl = '', array $connectionParams = [], string $companyName = '')
    {
        $this->baseUrl = $baseUrl;
        $this->connectionParams = $connectionParams;
        $this->companyName = $companyName;
        $this->dataHelper = ObjectManager::getInstance()->get(\Ls\Omni\Helper\Data::class);
    }

    public function execute(\Ls\Omni\Client\Ecommerce\Entity\TestConnectionOData_TestConnection $request = null): \Ls\Omni\Client\Ecommerce\Entity\TestConnectionResponseResponse
    {
        if ($request !== null) {
            $this->setRequest($request);
        }

        $raw = $this->dataHelper->makeRequest(
            \Ls\Omni\Client\Ecommerce\Entity\TestConnectionOData_TestConnection::ACTION_NAME,
            self::class,
            $this->request,
            $this->baseUrl,
            $this->connectionParams,
            ['company' => $this->companyName]
        );

        $response = $this->formatResponse($raw);
        $this->setResponse($response);

        return $response;
    }

    public function formatResponse($data): \Ls\Omni\Client\Ecommerce\Entity\TestConnectionResponseResponse
    {
        $fields = [];
        $rows = [];

        $recRef = $this->findNestedDataSet($data, 'TestConnectionResponse');
        if ($recRef && isset($recRef['DataSetFields'], $recRef['DataSetRows'])) {
            if (isset($recRef['DataSetFields'])) {
                foreach ($recRef['DataSetFields'] as $field) {
                    $fields[$field['FieldIndex']] = $field['FieldName'];
                }
            }

            if (isset($recRef['DataSetRows'])) {
                $rows = $recRef['DataSetRows'];
            }

            $entities = [];
            foreach ($rows as $row) {
                $entry = new \Ls\Omni\Client\Ecommerce\Entity\TestConnectionResponse();
                foreach ($row['Fields'] ?? [] as $field) {
                    $entry->setData($fields[$field['FieldIndex']], $field['FieldValue']);
                }
                $entities[] = $entry;
            }

            return new \Ls\Omni\Client\Ecommerce\Entity\TestConnectionResponseResponse([
                'records' => $entities,
                'ResponseCode' => $data['ResponseCode'] ?? '',
                'ErrorText' => $data['ErrorText'] ?? ''
            ]);
        }


            // Try flat response structure
        if (isset($data['TestConnectionResponse']) && is_array($data['TestConnectionResponse'])) {
            $entity = new \Ls\Omni\Client\Ecommerce\Entity\TestConnectionResponse($data['TestConnectionResponse']);

            return new \Ls\Omni\Client\Ecommerce\Entity\TestConnectionResponseResponse([
                'records' => [$entity],
                'ResponseCode' => $data['ResponseCode'] ?? '',
                'ErrorText' => $data['ErrorText'] ?? '',
            ]);
        }

        // Fallback
        return new \Ls\Omni\Client\Ecommerce\Entity\TestConnectionResponseResponse([
            'records' => [],
            'ResponseCode' => $data['ResponseCode'] ?? '',
            'ErrorText' => $data['ErrorText'] ?? 'Unable to parse response.',
        ]);
    }

    public function findNestedDataSet($data, string $target): ?array
    {
        if (is_array($data)) {
            foreach ($data as $key => $value) {
                if (is_array($value) || is_object($value)) {
                    $found = $this->findNestedDataSet((array)$value, $target);
                    if (!empty($found)) {
                        return $found;
                    }
                }

                if (
                    is_array($data)
                    && isset($data['DataSetName'])
                    && $data['DataSetName'] === $target
                ) {
                    return $data;
                }
            }
        }

        return null;
    }

    public function setRequest(\Ls\Omni\Client\Ecommerce\Entity\TestConnectionOData_TestConnection $request): self
    {
        $this->request = $request;
        return $this;
    }

    public function setResponse(\Ls\Omni\Client\Ecommerce\Entity\TestConnectionResponseResponse $response): self
    {
        $this->response = $response;
        return $this;
    }

    public function getRequest(): \Ls\Omni\Client\Ecommerce\Entity\TestConnectionOData_TestConnection
    {
        return $this->request;
    }

    public function getResponse(): \Ls\Omni\Client\Ecommerce\Entity\TestConnectionResponseResponse
    {
        return $this->response;
    }
}