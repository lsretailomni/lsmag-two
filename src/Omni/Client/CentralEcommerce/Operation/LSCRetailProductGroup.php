<?php
/**
 * THIS IS AN AUTOGENERATED FILE
 * DO NOT MODIFY
 * @codingStandardsIgnoreFile
 */

namespace Ls\Omni\Client\CentralEcommerce\Operation;

use Magento\Framework\App\ObjectManager;

class LSCRetailProductGroup
{
    public string $baseUrl;
    public array $connectionParams;
    public string $companyName;
    public \Ls\Omni\Client\CentralEcommerce\Entity\ODataRequest_GetProductGroup $request;
    public \Ls\Omni\Client\CentralEcommerce\Entity\LSCRetailProductGroupResponse $response;
    public \Ls\Omni\Helper\Data $dataHelper;

    public function __construct($baseUrl = '', $connectionParams = [], $companyName = '')
    {
        $this->baseUrl = $baseUrl;
        $this->connectionParams = $connectionParams;
        $this->companyName = $companyName;
        $this->dataHelper = $this->createInstance(\Ls\Omni\Helper\Data::class);
        $this->request = $this->createInstance(\Ls\Omni\Client\CentralEcommerce\Entity\ODataRequest_GetProductGroup::class);
    }

    public function execute(): \Ls\Omni\Client\CentralEcommerce\Entity\LSCRetailProductGroupResponse
    {
        $response = $this->dataHelper->makeRequest(
            \Ls\Omni\Client\CentralEcommerce\Entity\ODataRequest_GetProductGroup::ACTION_NAME,
            \Ls\Omni\Client\CentralEcommerce\Entity\LSCRetailProductGroup::class,
            $this->request,
            $this->baseUrl,
            $this->connectionParams,
            ['company' => $this->companyName]
        );

        $response = $this->formatResponse($response);

        $this->setResponse($response);

        return $response;
    }

    public function formatResponse($data): \Ls\Omni\Client\CentralEcommerce\Entity\LSCRetailProductGroupResponse
    {
        if (isset($data['TableData']['TableDataUpd']['RecRefJson'])) {
            $recRef = $data['TableData']['TableDataUpd']['RecRefJson'];
        } elseif (isset($data['DataSet']['DataSetUpd']['DynDataSet'])) {
            $recRef = $data['DataSet']['DataSetUpd']['DynDataSet'];
        } else {
            $recRef = [];
        }

        $deletedRows = [];
        if (isset($data['DataSet']['DataSetDel']['DynDataSet']['DataSetRows'])) {
            $deletedRows = $data['DataSet']['DataSetDel']['DynDataSet']['DataSetRows'];
        }

        if (isset($recRef['RecordFields'])) {
            $fieldsDefinition = $recRef['RecordFields'];
        } elseif (isset($recRef['DataSetFields'])) {
            $fieldsDefinition = $recRef['DataSetFields'];
        } else {
            $fieldsDefinition = [];
        }

        $deletedFieldsDefinition = [];
        if (isset($data['DataSet']['DataSetDel']['DynDataSet']['DataSetFields'])) {
            $deletedFieldsDefinition = $data['DataSet']['DataSetDel']['DynDataSet']['DataSetFields'];
        }

        $dataSetName = '';
        if (isset($recRef['Records'])) {
            $rows = $recRef['Records'];
        } elseif (isset($recRef['DataSetRows'])) {
            $rows = $recRef['DataSetRows'];
            $dataSetName = $recRef['DataSetName'];
        } else {
            $rows = [];
        }


        foreach ($fieldsDefinition as $field) {
            $fields[$field['FieldIndex']] = $field['FieldName'];
        }

        foreach ($deletedFieldsDefinition as $field) {
            $deletedFields[$field['FieldIndex']] = $field['FieldName'];
        }

        $results = [];
        if (!empty($fields)) {
            foreach ($rows as $row) {
                $values = $row['Fields'] ?? [];
                $entry = $this->createInstance(
                    \Ls\Omni\Client\CentralEcommerce\Entity\LSCRetailProductGroup::class
                );
                foreach ($values as $value) {
                    $sameNameExists = false;
                    $fieldName = $fields[$value['FieldIndex']];
                    if (isset(\Ls\Replication\Helper\ReplicationHelper::SAME_NAME_MAPPING[$dataSetName][$fieldName])) {
                        $sameNameExists = true;
                    }
                    if (strtolower($fieldName) == 'id') {
                        $fieldName = 'Nav Id';
                    }
                    if ((!$sameNameExists && $entry->getData($fieldName) === null) ||
                    ($sameNameExists &&
                    $entry->getData(\Ls\Replication\Helper\ReplicationHelper::SAME_NAME_MAPPING[$dataSetName][$fieldName][0]) === null)
                    ) {
                        if ($sameNameExists) {
                            $fieldName = \Ls\Replication\Helper\ReplicationHelper::SAME_NAME_MAPPING[$dataSetName][$fieldName][0];
                        }
                        $entry->setData($fieldName, $value['FieldValue']);
                    } else {
                        if ($sameNameExists) {
                            $fieldName = \Ls\Replication\Helper\ReplicationHelper::SAME_NAME_MAPPING[$dataSetName][$fieldName][1];
                            $entry->setData($fieldName, $value['FieldValue']);
                        }
                    }
                }
                $results[] = $entry;
            }
        }

        if (!empty($deletedFields)) {
            foreach ($deletedRows as $row) {
                $values = $row['Fields'] ?? [];
                $entry = $this->createInstance(
                    \Ls\Omni\Client\CentralEcommerce\Entity\LSCRetailProductGroup::class
                );
                $entry->setData('is_deleted', true);
                foreach ($values as $value) {
                    $fieldName = $deletedFields[$value['FieldIndex']];
                    if (isset(\Ls\Replication\Helper\ReplicationHelper::SAME_NAME_MAPPING[$dataSetName][$fieldName])) {
                        $sameNameExists = true;
                    }
                    if (strtolower($fieldName) == 'id') {
                        $fieldName = 'Nav Id';
                    }
                    if ((!$sameNameExists && $entry->getData($fieldName) === null) ||
                    ($sameNameExists &&
                    $entry->getData(\Ls\Replication\Helper\ReplicationHelper::SAME_NAME_MAPPING[$dataSetName][$fieldName][0]) === null)
                    ) {
                        if ($sameNameExists) {
                            $fieldName = \Ls\Replication\Helper\ReplicationHelper::SAME_NAME_MAPPING[$dataSetName][$fieldName][0];
                        }
                        $entry->setData($fieldName, $value['FieldValue']);
                    } else {
                        if ($sameNameExists) {
                            $fieldName = \Ls\Replication\Helper\ReplicationHelper::SAME_NAME_MAPPING[$dataSetName][$fieldName][1];
                            $entry->setData($fieldName, $value['FieldValue']);
                        }
                    }
                }
                $results[] = $entry;
            }
        }

        return $this->createInstance(
                    \Ls\Omni\Client\CentralEcommerce\Entity\LSCRetailProductGroupResponse::class,
                     [
                        'data' => [
                        'records' => $results,
                        'status' => $data['Status'] ?? '',
                        'errorText' => $data['ErrorText'] ?? '',
                        'lastKey' => $data['LastKey'] ?? '',
                        'lastEntryNo' => $data['LastEntryNo'] ?? 0,
                        'endOfTable' => $data['EndOfTable'] ?? false
                        ]
                     ]
                );
    }

    public function createInstance(string $entityClassName, array $data = [])
    {
        return ObjectManager::getInstance()->create($entityClassName, $data);
    }

    public function & setOperationInput(array $params = []): \Ls\Omni\Client\CentralEcommerce\Entity\ODataRequest_GetProductGroup
    {
        $this->setRequest(
            $this->createInstance(
                \Ls\Omni\Client\CentralEcommerce\Entity\ODataRequest_GetProductGroup::class,
                ['data' => $params]
            )
        );
        $request = $this->getRequest();

        return $request;
    }


    public function setRequest(\Ls\Omni\Client\CentralEcommerce\Entity\ODataRequest_GetProductGroup $request): self
    {
        $this->request = $request;
        return $this;
    }

    public function setResponse(\Ls\Omni\Client\CentralEcommerce\Entity\LSCRetailProductGroupResponse $response): self
    {
        $this->response = $response;
        return $this;
    }

    public function getRequest(): \Ls\Omni\Client\CentralEcommerce\Entity\ODataRequest_GetProductGroup
    {
        return $this->request;
    }

    public function getResponse(): \Ls\Omni\Client\CentralEcommerce\Entity\LSCRetailProductGroupResponse
    {
        return $this->response;
    }
}